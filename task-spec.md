# 任务细则：优化三个命令的分步执行机制

## 任务概述

优化 `docs.md`、`user-docs.md`、`user-graph.md` 三个命令的分步执行和接续执行机制，使其能够真正支持大型项目（百万行代码级别）的分步处理。

## 问题诊断

### 当前实现的共性问题

| 问题 | 说明 |
|------|------|
| 步骤粒度错误 | 基于"逻辑单元"（如区块、文档类型）而非"上下文消耗量"划分 |
| 计划文档信息不足 | 只记录"做什么+状态"，不记录具体执行所需的输入信息 |
| 接续成本高 | 每次对话需重新扫描目录、重新理解项目结构 |
| 中间产物缺失 | 分析结果未持久化，需反复执行相同分析 |

### 各命令的特定问题

**docs.md（项目文档管理）**：
- "完全深度探索每个文件"对大型项目意味着海量工作
- 区块计划只记录区块级状态，无法追踪区块内文件级进度
- 单个区块可能包含数千文件，无法在单次对话完成

**user-docs.md（用户文档生成）**：
- 步骤如"生成 getting-started.md"没有附带所需的输入信息
- 接续执行需重新读取项目文档

**user-graph.md（用户流程图生成）**：
- 步骤如"编写 guide.puml"没有附带已分析好的模块结构
- 接续执行需重新分析代码

## 解决方案

### 核心设计：索引式计划文档

采用用户选择的**索引式**组织方式：
- `plan.md`：只做索引，记录步骤列表和整体进度
- `steps/step-XX.md`：每个步骤的详细执行说明

### 步骤文档格式

每个步骤文档应包含完整的执行所需信息：

```markdown
# 步骤 XX：[步骤名称]

## 元信息
- 状态：pending / in_progress / completed
- 依赖：step-YY（如有）
- 预估工作量：小 / 中 / 大

## 任务描述
[具体要做什么]

## 输入信息
[执行此步骤所需的全部信息，已整理好]

### 相关文件
- `path/to/file1` - 说明
- `path/to/file2` - 说明

### 已分析的结构（如适用）
[模块结构、关键函数、数据流等已分析好的信息]

## 输出要求
- 文件：[产出文件路径]
- 格式：[格式要求]
- 内容：[内容要求]

## 执行记录
（执行时填写）
- 开始时间：
- 完成时间：
- 备注：
```

### 两阶段模型

**阶段 A：深度分析阶段**
- 扫描项目结构
- 划分区块/步骤
- 为每个步骤生成详细的步骤文档（包含所有输入信息）
- 可能需要多次对话完成

**阶段 B：执行阶段**
- 读取步骤文档
- 直接基于输入信息产出
- 无需重新分析

### 粒度控制原则

步骤粒度应基于"单次对话可完成"的工作量：

| 项目规模 | 建议步骤粒度 |
|----------|-------------|
| 小型（<1万行） | 可按逻辑单元划分 |
| 中型（1-10万行） | 按模块或文件组划分 |
| 大型（10万+行） | 按文件或小文件组划分 |

## 具体修改计划

### 1. 修改 docs.md

**修改点**：
1. 区块计划升级为索引式
2. 增加"步骤生成"阶段：为每个区块生成详细步骤文档
3. 步骤文档包含：该步骤要分析的文件列表、已知的目录结构
4. 支持区块内的细粒度进度追踪

**新增文件结构**：
```
.aide/project-docs/
├── README.md              # 总导览
├── block-plan.md          # 区块计划（索引）
├── steps/                 # 步骤详情目录
│   ├── step-01.md         # 步骤1详情
│   ├── step-02.md         # 步骤2详情
│   └── ...
└── blocks/                # 区块文档
    └── ...
```

### 2. 修改 user-docs.md

**修改点**：
1. 计划文档升级为索引式
2. 步骤文档包含：该文档需要的源信息（已从项目文档提取）
3. 执行阶段直接基于步骤文档产出

**新增文件结构**：
```
docs/
├── user-docs-plan.md      # 计划文件（索引）
├── steps/                 # 步骤详情目录
│   ├── step-01.md
│   └── ...
└── [generated docs]       # 生成的文档
```

### 3. 修改 user-graph.md

**修改点**：
1. 计划文档升级为索引式
2. 步骤文档包含：该流程图需要的模块结构（已分析好）
3. 执行阶段直接基于步骤文档绘图

**新增文件结构**：
```
docs/graph-guide/
├── plan.md                # 计划文件（索引）
├── steps/                 # 步骤详情目录
│   ├── step-01.md
│   └── ...
└── [block dirs]           # 流程图目录
```

## 成功标准

1. **分析阶段可独立完成**：即使上下文耗尽，分析结果已保存在步骤文档中
2. **执行阶段低成本接续**：只需读取步骤文档即可继续，无需重新分析
3. **粒度可控**：大型项目的步骤粒度足够细，单次对话可完成
4. **进度可追踪**：每个步骤有独立状态，整体进度一目了然

## 验证方法

1. 审阅修改后的命令文件，确认逻辑正确
2. 模拟大型项目场景，验证步骤划分是否合理
3. 检查步骤文档格式是否包含足够的执行信息

## 执行顺序

1. 修改 docs.md（依赖最少，可先完成）
2. 修改 user-graph.md
3. 修改 user-docs.md
