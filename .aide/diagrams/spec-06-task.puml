@startuml spec-06-task
!theme plain
title 子计划6: 返工流程优化 - 任务执行流程图

start

partition "6.1 创建 rework skill" {
    :创建 skills/rework/ 目录;
    :编写 SKILL.md;
    note right
      包含：
      - 返工类型判断
      - 返工到 task-optimize 流程
      - 返工到其他阶段流程
      - 提醒用户模板
      - 确认机制说明
    end note
}

partition "6.2 修改 /aide:run 命令" {
    :打开 commands/run.md;
    :在 confirm 阶段返工流程部分;
    :添加触发 rework skill 的指引;
}

partition "6.3 修改 aide-program" {
    partition "修改 back-part 命令" {
        :打开 main.py;
        :修改 handle_flow_back_part();
        :添加状态文件检查;
        :添加 key 生成逻辑;
        :添加状态文件写入;
    }

    partition "新增 back-confirm 命令" {
        :在 main.py 添加命令解析;
        :实现 handle_flow_back_confirm();
        :验证 key;
        :清理状态文件;
        :执行 back-part;
        :创建清洁提交;
        :输出警告;
    }
}

partition "6.4 验证" {
    :测试 back-part 生成 key;
    :测试 back-confirm 验证和执行;
    :测试清洁提交创建;
    :测试状态文件清理;
}

stop

@enduml
