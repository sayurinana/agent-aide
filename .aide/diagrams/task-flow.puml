@startuml task-flow
!theme plain
title 任务执行流程图：调整 Aide 工作流流程

start

partition "1. 准备阶段" {
  :读取 config.py;
  :添加 plans_path 默认配置;
}

partition "2. run.md 修改 - 任务细则部分" {
  :定位"1.8 生成任务细则"部分;
  :增加复杂任务处理逻辑;
  note right
    - 判断是否为复杂任务
    - 创建 .aide/task-plans/ 目录
    - 生成 guide.md 总导览
    - 生成 spec-NN.md 子计划
  end note
}

partition "3. run.md 修改 - 子计划执行部分" {
  :定位"复杂任务的子计划执行"部分;
  :明确文档结构和操作方式;
}

partition "4. run.md 修改 - 插入 confirm 阶段" {
  :定位"阶段 5：文档更新"之后;
  :插入"阶段 6：用户确认 (confirm)";
  note right
    - 报告完成信息
    - 等待用户确认
    - 返工机制说明
  end note
  :将原"阶段 6：收尾"改为"阶段 7：收尾";
}

partition "5. aide skill 更新" {
  :读取 aide.md;
  :添加 plans_path 配置说明;
  :更新环节列表（增加 confirm）;
}

partition "6. 验证" {
  :检查所有修改点;
  if (验证通过?) then (是)
    :完成;
  else (否)
    :修复问题;
  endif
}

stop

@enduml
