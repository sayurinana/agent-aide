@startuml subplan3-plantuml
!theme plain
title 子计划 3: aide flow 流程图集成

start

partition "1. 创建 plantuml 环境模块" {
    :创建 env/modules/plantuml.py;
    :继承 BaseModule;
    :实现 check() 方法;
    note right
        检查:
        - java 命令可用
        - jar 文件存在
    end note
    :注册到 registry;
}

partition "2. 实现校验功能" {
    :创建 flow/plantuml.py;
    :实现 validate_puml(file_path);
    note right
        调用: java -jar plantuml.jar -checkonly file.puml
        返回: (success, error_message)
    end note
    :实现 validate_all(directory);
    note right
        遍历目录下所有 .puml 文件
        返回: [(file, success, error)]
    end note
}

partition "3. 实现构建功能" {
    :实现 build_puml(file_path);
    note right
        调用: java -jar plantuml.jar -tpng file.puml
        生成: file.png
    end note
    :实现 build_all(directory);
    note right
        遍历目录下所有 .puml 文件
        批量生成 PNG
    end note
}

partition "4. 集成到 flow 逻辑" {
    :修改 hooks.py;

    :修改 next-step 钩子;
    if (当前环节 == flow-design?) then (是)
        :校验流程图目录;
        if (校验通过?) then (是)
            :继续执行;
        else (否)
            :记录问题到 git;
            :返回错误提示;
        endif
    endif

    :修改 next-part impl 钩子;
    if (从 flow-design 进入?) then (是)
        :校验所有 .puml 文件;
        if (校验通过?) then (是)
            :批量构建 PNG;
            :继续执行;
        else (否)
            :记录问题到 git;
            :返回错误提示;
        endif
    endif
}

partition "5. 更新设计文档" {
    :更新 hooks 设计文档;
    :更新 flow 设计文档;
}

:测试集成功能;

stop
@enduml
