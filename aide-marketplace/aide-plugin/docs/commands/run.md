# /aide:run 命令设计文档

## 一、概述

`/aide:run` 是任务执行的核心命令，整合了任务准备和任务执行功能。

### 1.1 设计目标

| 目标 | 说明 |
|------|------|
| 统一入口 | 一个命令完成任务准备和执行 |
| 状态感知 | 自动检测 flow 状态，支持续接 |
| 复杂度适应 | 支持简单任务直接执行，复杂任务拆分子计划 |

### 1.2 与旧命令的关系

本命令整合了原 `/aide:prep` 和 `/aide:exec` 的功能。

---

## 二、执行流程

### 2.1 总体流程

```
┌─────────────────────────────────────────┐
│            /aide:run                     │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     强制触发 aide skill                  │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     aide flow status                     │
│     (检查当前 flow 状态)                 │
└─────────────────────────────────────────┘
                    │
        ┌──────────┴──────────┐
        ▼                     ▼
   [无活跃任务]          [有活跃任务]
   [或已 finish]         [未完成]
        │                     │
        ▼                     ▼
   新任务流程              续接流程
```

### 2.2 新任务流程

```
┌─────────────────────────────────────────┐
│     task-optimize (任务准备)             │
├─────────────────────────────────────────┤
│ 1. aide flow start task-optimize        │
│ 2. 读取任务文档                          │
│ 3. 任务分析                              │
│ 4. 复杂度评估                            │
│ 5. 任务优化                              │
│ 6. 待定项处理（如有）                    │
│ 7. 生成任务细则                          │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     flow-design (流程设计)               │
├─────────────────────────────────────────┤
│ 1. aide flow next-part flow-design      │
│ 2. 制定执行计划                          │
│ 3. 创建流程图（PlantUML）                │
│ 4. aide flow next-part impl             │
│    (自动校验并生成 PNG)                  │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     impl (迭代实现)                      │
├─────────────────────────────────────────┤
│ 按计划执行，每步记录：                   │
│ aide flow next-step "<完成内容>"         │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     verify (验证交付)                    │
├─────────────────────────────────────────┤
│ 1. aide flow next-part verify           │
│ 2. 对照任务细则验证                      │
│ 3. 执行测试（如适用）                    │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     docs (文档更新)                      │
├─────────────────────────────────────────┤
│ 1. aide flow next-part docs             │
│ 2. 更新 README、CHANGELOG 等            │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     finish (收尾)                        │
├─────────────────────────────────────────┤
│ 1. aide flow next-part finish           │
│ 2. 清理临时文件                          │
│ 3. 向用户汇报                            │
└─────────────────────────────────────────┘
```

### 2.3 续接流程

```
┌─────────────────────────────────────────┐
│     分析当前进度                         │
├─────────────────────────────────────────┤
│ aide flow status                         │
│ aide flow show <task_id>                 │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     载入项目认知                         │
├─────────────────────────────────────────┤
│ 调用 /aide:load 逻辑                     │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     读取任务细则                         │
├─────────────────────────────────────────┤
│ aide config get task.spec                │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│     从中断处继续执行                     │
└─────────────────────────────────────────┘
```

---

## 三、复杂任务处理

### 3.1 复杂度评估

根据**任务复杂度评估指导原则**判断：

| 等级 | 特征 | 处理方式 |
|------|------|----------|
| 简单 | 单文件或少量文件 | 直接执行 |
| 中等 | 2-4 个模块 | 直接执行 |
| 复杂 | 5+ 模块 | **拆分子计划** |
| 超大 | 10+ 模块 | 拆分独立任务 |

### 3.2 子计划执行模式

```
task-optimize
    │
    ▼
[flow-design → impl → verify → docs] × N
    │
    ▼
finish
```

每个子计划完成 docs 后，回退到 flow-design 开始下一个子计划。

---

## 四、职责边界

### 4.1 本命令负责

- 检查 flow 状态
- 任务分析和优化
- 复杂度评估和子计划拆分
- 待定项处理
- 流程设计和流程图创建
- 迭代实现
- 验证交付
- 文档更新
- 收尾汇报

### 4.2 本命令不负责

- 环境配置（由 `/aide:setup` 负责）
- 项目文档创建和维护（由 `/aide:docs` 负责）

---

## 五、触发的 Skill

| Skill | 触发方式 | 用途 |
|-------|----------|------|
| aide | 强制触发 | 提供 aide 命令使用指南 |

---

## 六、相关文档

- [执行文件](../../commands/run.md)
- [aide skill](../../skills/aide/SKILL.md)
- [aide flow 子命令](../../../../aide-program/docs/commands/flow.md)
- [aide decide 子命令](../../../../aide-program/docs/commands/decide.md)
- [plugin 导览](../README.md)

---

## 七、版本信息

- 创建日期：2025-12-15
- 整合原 `/aide:prep` 和 `/aide:exec`
