@startuml env
skinparam defaultFontName "PingFang SC"
skinparam dpi 300
scale 0.5

title aide env ensure 流程

|EnvManager|
start

:加载配置;
note right: config.toml [env] 节

:获取启用的模块列表;
note right
  默认：python, uv
  可配置：venv, requirements,
  rust, node, flutter, android, node_deps
end note

if (--runtime 参数?) then (是)
    :仅检测运行时模块;
    note right: python, uv
else (否)
    :检测所有启用模块;
endif

|Registry|
:从 modules/ 加载模块;
:返回模块实例列表;

|EnvManager|
while (遍历模块列表) is (还有模块)
    :获取下一个模块;

    |Module|
    :validate_config(config);
    if (配置验证) then (失败)
        :返回配置错误;
        |EnvManager|
        #Pink:输出 ✗ 配置错误;
    else (通过)
        :check(config, root);
        if (检测结果) then (通过)
            |EnvManager|
            #LightGreen:输出 ✓ 检测通过;
        else (失败)
            if (模块支持 ensure?) then (是)
                :ensure(config, root);
                if (修复结果) then (成功)
                    |EnvManager|
                    #LightGreen:输出 ✓ 修复成功;
                else (失败)
                    |EnvManager|
                    #Pink:输出 ✗ 修复失败;
                endif
            else (否)
                |EnvManager|
                #Orange:输出 ⚠ 需要手动处理;
            endif
        endif
    endif
endwhile (完成)

|EnvManager|
:汇总结果;

if (全部通过?) then (是)
    #LightGreen:输出 ✓ 环境就绪;
else (否)
    #Pink:输出 ✗ 环境检测失败;
endif

stop

legend right
  **模块类型**
  ----
  **类型 A（全局检测）**
  - python：版本检测
  - uv：包管理器检测
  - rust：Rust 工具链
  - node：Node.js 运行时
  - flutter：Flutter SDK
  - android：Android SDK
  ----
  **类型 B（项目级）**
  - venv：虚拟环境 (check + ensure)
  - requirements：依赖管理 (check + ensure)
  - node_deps：Node 依赖 (check + ensure)
endlegend

@enduml
